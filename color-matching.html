<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¸ì§€ ì¬í™œ í›ˆë ¨: ìƒ‰ê¹” ë§ì¶”ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Material Symbols Font ì¶”ê°€ -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <style>
        /* í°íŠ¸ ì •ì˜ */
        @font-face {
            font-family: 'HappinessSansTitle';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/Happiness-Sans-Title.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        /* ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f0f9ff;
            color: #0f172a;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* íƒ€ì´í‹€ í°íŠ¸ í´ë˜ìŠ¤ */
        .font-title { font-family: 'HappinessSansTitle', sans-serif; }
        .game-font { font-family: 'Jua', sans-serif; }
        .text-body { font-family: 'Noto Sans KR', sans-serif; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        main {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        /* ì¤‘ì•™ ì •ë ¬ ì»¨í…Œì´ë„ˆ */
        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-top: 10vh;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-indicator {
            width: 18vh; 
            height: 18vh;
            max-width: 150px;
            max-height: 150px;
            min-width: 90px;
            min-height: 90px;
            
            border-radius: 24px;
            border-bottom: 8px solid rgba(0,0,0,0.15);
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: clamp(1.2rem, 3vh, 2rem);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            background-color: white;
            position: relative;
        }

        .btn-indicator:active, .btn-indicator.active {
            transform: translateY(4px);
            border-bottom-width: 4px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            filter: brightness(0.95);
        }

        /* ë¬¸ì œ í‘œì‹œ ì˜ì—­ (ë¸”ëŸ­ í˜•íƒœ) */
        .sequence-block {
            width: 16vh;
            height: 16vh;
            max-width: 130px;
            max-height: 130px;
            min-width: 70px;
            min-height: 70px;
            
            border-radius: 20px;
            margin: 0 8px;
            border: 6px solid #cbd5e1;
            background-color: #e2e8f0;
            transition: all 0.2s;
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0;
        }

        /* í™œì„±í™” ìƒíƒœ */
        .sequence-block.lit { 
            transform: scale(1.05); 
            border-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        /* ì™„ë£Œ ìƒíƒœ */
        .sequence-block.done { 
            opacity: 0.4; 
            transform: scale(0.9); 
            background-color: #64748b !important;
            border-color: #475569;
            box-shadow: none;
        }

        /* ìƒ‰ìƒ ì •ì˜ */
        .color-green { color: #000; background-color: #4ade80; border-color: #22c55e; }
        .color-red { color: #fff; background-color: #ef4444; border-color: #b91c1c; }
        .color-blue { color: #fff; background-color: #3b82f6; border-color: #1d4ed8; }
        .color-yellow { color: #000; background-color: #facc15; border-color: #ca8a04; }
        
        .sequence-block.color-green { background-color: #4ade80; border-color: #22c55e; }
        .sequence-block.color-red { background-color: #ef4444; border-color: #b91c1c; }
        .sequence-block.color-blue { background-color: #3b82f6; border-color: #1d4ed8; }
        .sequence-block.color-yellow { background-color: #facc15; border-color: #ca8a04; }

        /* íŒ¨ë“œ ë ˆì´ì•„ì›ƒ */
        .pad-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(12px, 2vh, 24px);
            padding: clamp(16px, 2.5vh, 32px);
            background: rgba(255, 255, 255, 0.7);
            border-radius: 40px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }

        /* ë©”ë‰´ ì•„ì´í…œ */
        .menu-item {
            width: 100%;
            height: 100%;
            min-height: 80px;
            padding: 12px;
            background: white;
            border: 3px solid #cbd5e1;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #334155;
            box-shadow: 0 5px 0 #94a3b8;
            text-align: center;
        }
        .menu-item:active { transform: translateY(5px); box-shadow: none; }
        .menu-item.selected {
            background: #fff1f2;
            color: #e11d48;
            border-color: #fda4af;
            box-shadow: 0 5px 0 #fb7185;
            transform: scale(1.02);
        }

        /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            transition: all 0.3s ease;
        }

        /* íŒì¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        /* íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .text-responsive-title { 
            font-size: clamp(3rem, 10vh, 5.5rem); 
            line-height: 1.2;
            color: #334155; /* Slate-700 ê¹”ë”í•œ ë‹¨ìƒ‰ */
        }
        .text-responsive-msg { font-size: clamp(2.5rem, 10vw, 5rem); }
        
        /* ë””ë°”ì´ìŠ¤ ì„œí´ */
        .device-circle {
            width: 64px; height: 64px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            background-color: white;
        }
        .device-circle:active { transform: scale(0.95); }

        /* ì•„ì´ì½˜ ìƒ‰ìƒ í…Œë§ˆ */
        .device-active { border-color: #3b82f6; box-shadow: 0 0 0 3px #bfdbfe; }
        .device-active .material-symbols-rounded { color: #2563eb; } /* Blue for Touch/Mouse */
        
        /* ì¡°ì´ìŠ¤í‹± í™œì„±/ë¹„í™œì„± ìŠ¤íƒ€ì¼ */
        .device-joystick-active { border-color: #f43f5e; box-shadow: 0 0 0 3px #fecdd3; } 
        .device-joystick-active .material-symbols-rounded { color: #f43f5e; } /* Rose-500 */

        .device-joystick-inactive { border-color: #cbd5e1; background-color: #f8fafc; }
        .device-joystick-inactive .material-symbols-rounded { color: #94a3b8; } /* Gray-400 */

        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: none;
        }
        .toast-msg {
            background-color: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin-top: 10px;
            animation: slideUpFade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>

    <main>
        <!-- 1. ë©”ë‰´ í™”ë©´ -->
        <div id="screen-menu" class="w-full h-full px-4 relative">
            <div class="center-container">
                
                <!-- íƒ€ì´í‹€: í°íŠ¸ ë³€ê²½ ë° ë‹¨ìƒ‰ ì ìš© -->
                <h1 class="text-responsive-title font-title font-bold tracking-tight mb-4 text-center">
                    ìƒ‰ê¹” ë§ì¶”ê¸°
                </h1>
                <p class="text-xl sm:text-2xl text-slate-500 mb-10 font-medium text-center">ìˆœì„œëŒ€ë¡œ ìƒ‰ê¹”ì„ ê¸°ì–µí•˜ì—¬ ëˆ„ë¥´ì„¸ìš”</p>

                <!-- ë ˆë²¨ ë¦¬ìŠ¤íŠ¸ -->
                <div id="level-list" class="w-full max-w-4xl mb-10 grid grid-cols-3 grid-rows-2 gap-4 sm:gap-6 px-2">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
                </div>

                <!-- í›ˆë ¨ íš¨ê³¼ ë³´ê¸° ë²„íŠ¼ -->
                <button onclick="openEffectModal()" class="w-full max-w-md flex items-center justify-center gap-3 text-white font-bold bg-indigo-600 hover:bg-indigo-700 border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1 px-8 py-3 rounded-2xl shadow-lg transition-all text-lg sm:text-xl mb-12">
                    <span class="material-symbols-rounded text-3xl">description</span>
                    ì¬í™œ í›ˆë ¨ íš¨ê³¼ í™•ì¸í•˜ê¸°
                </button>

                <!-- í•˜ë‹¨ ì¤‘ì•™: ì…ë ¥ ì¥ì¹˜ ì•„ì´ì½˜ (Material Symbols ì ìš©) -->
                <div class="flex items-center gap-6 mt-auto mb-12">
                    <!-- Touch -->
                    <div class="device-circle device-active" onclick="showToast('ğŸ‘† í„°ì¹˜ë¡œ í”Œë ˆì´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.')">
                        <span class="material-symbols-rounded text-3xl">touch_app</span>
                    </div>
                    <!-- Mouse -->
                    <div class="device-circle device-active" onclick="showToast('ğŸ–±ï¸ ë§ˆìš°ìŠ¤ë¡œ í”Œë ˆì´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.')">
                        <span class="material-symbols-rounded text-3xl">mouse</span>
                    </div>
                    <!-- Joystick -->
                    <div id="icon-joystick-container" class="device-circle device-joystick-inactive" onclick="showJoystickToast()">
                        <span class="material-symbols-rounded text-3xl">sports_esports</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ê²Œì„ í”Œë ˆì´ í™”ë©´ -->
        <div id="screen-game" class="hidden w-full h-full relative">
            
            <!-- ì²˜ìŒìœ¼ë¡œ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •, ê²¹ì¹¨ í•´ê²°) -->
            <div class="absolute top-4 right-4 z-50">
                <button onclick="goToMenuConfirm()" class="bg-white hover:bg-slate-50 text-slate-600 hover:text-rose-500 px-5 py-3 rounded-2xl text-base font-bold transition-all flex items-center gap-2 shadow-lg border border-slate-200 active:scale-95">
                    <span class="material-symbols-rounded">home</span>
                    ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>

            <!-- ìƒë‹¨ HUD -->
            <div class="w-full h-full flex flex-col items-center justify-between py-6">
                
                <!-- HUD Header -->
                <div class="w-full max-w-4xl flex justify-between items-end px-4 sm:px-8 border-b border-slate-200 pb-4 mt-20 relative">
                    <div class="text-center">
                        <span class="text-slate-400 text-sm block font-bold">ë‹¨ê³„ (LEVEL)</span>
                        <span class="text-3xl sm:text-4xl font-black text-sky-600" id="display-level">1</span>
                    </div>
                    
                    <div class="text-center pb-1 mx-auto">
                        <span class="text-slate-400 text-xs block font-bold">ì§ì „ ë°˜ì‘ì†ë„</span>
                        <span class="text-xl sm:text-2xl font-bold text-slate-700" id="current-speed">-</span>
                    </div>
                    <div class="text-center">
                        <span class="text-slate-400 text-sm block font-bold">ë¬¸ì œ (ROUND)</span>
                        <span class="text-3xl sm:text-4xl font-black text-sky-600"><span id="display-round">1</span><span class="text-2xl text-slate-400">/10</span></span>
                    </div>
                </div>

                <!-- ì¤‘ì•™ ì˜ì—­ ì»¨í…Œì´ë„ˆ (ë¬¸ì œ í‘œì‹œ) -->
                <div class="flex-grow flex flex-col items-center justify-center w-full gap-8">
                    <div id="sequence-container" class="flex justify-center items-center h-auto w-full max-w-5xl px-2 flex-wrap gap-3"></div>
                    <div class="h-20 flex items-center justify-center">
                        <div class="text-responsive-msg font-black game-font text-slate-700 drop-shadow-sm whitespace-nowrap" id="msg-center">ì¤€ë¹„</div>
                    </div>
                </div>

                <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­ -->
                <div class="w-full flex justify-center pb-8 px-4">
                    <div class="pad-layout">
                        <!-- ì´ˆë¡: ë„¤ëª¨(â– ) - B2 -->
                        <div id="feedback-2" class="btn-indicator color-green" onclick="handleTouch(2)">
                            <span class="mb-1 text-3xl">â– </span><span class="text-lg">ì´ˆë¡</span>
                        </div>
                        <!-- íŒŒë‘: ì„¸ëª¨(â–²) - B3 -->
                        <div id="feedback-3" class="btn-indicator color-blue" onclick="handleTouch(3)">
                            <span class="mb-1 text-3xl">â–²</span><span class="text-lg">íŒŒë‘</span>
                        </div>
                        <!-- ë¹¨ê°•: X(âœ–) - B0 -->
                        <div id="feedback-0" class="btn-indicator color-red" onclick="handleTouch(0)">
                            <span class="mb-1 text-3xl">âœ–</span><span class="text-lg">ë¹¨ê°•</span>
                        </div>
                        <!-- ë…¸ë‘: ë™ê·¸ë¼ë¯¸(â—) - B1 -->
                        <div id="feedback-1" class="btn-indicator color-yellow" onclick="handleTouch(1)">
                            <span class="mb-1 text-3xl">â—</span><span class="text-lg">ë…¸ë‘</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ê²°ê³¼ í™”ë©´ -->
        <div id="screen-result" class="hidden w-full h-full relative px-4">
            <div class="center-container">
                <h2 class="text-6xl font-black mb-2 text-sky-600 pop-in">í›ˆë ¨ ì™„ë£Œ</h2>
                <div class="text-2xl text-slate-500 mb-8">Level <span id="result-level-num">1</span> ì¢…ë£Œ</div>

                <div class="w-full max-w-3xl bg-white p-8 rounded-[3rem] shadow-2xl border border-slate-100 pop-in mb-8 flex flex-col gap-6" style="max-height: 65vh; overflow-y: auto;">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="text-center p-6 bg-indigo-50 rounded-3xl">
                            <p class="text-slate-500 font-bold mb-2">í‰ê·  ë°˜ì‘ ì†ë„</p>
                            <p class="text-5xl font-black text-indigo-600" id="result-avg-time">0ms</p>
                        </div>
                        <div class="text-center p-6 bg-rose-50 rounded-3xl">
                            <p class="text-slate-500 font-bold mb-2">ì •í™•ë„</p>
                            <p class="text-5xl font-black text-rose-500" id="result-accuracy">100%</p>
                        </div>
                    </div>
                    <div class="border-t border-slate-100 pt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span class="material-symbols-rounded text-2xl text-indigo-500">psychology</span>
                            ëŠ”ì§€ ê¸°ëŠ¥ ë¶„ì„ í”¼ë“œë°±
                        </h3>
                        <p class="text-body text-slate-600 leading-relaxed text-lg bg-slate-50 p-6 rounded-2xl" id="result-feedback">ë¶„ì„ ì¤‘...</p>
                    </div>
                </div>

                <button onclick="goToMenu()" class="w-full max-w-md bg-sky-500 hover:bg-sky-600 text-white font-bold py-5 rounded-2xl text-2xl shadow-xl transition-transform active:scale-95 mb-4">
                    í™•ì¸ (ë©”ë‰´ë¡œ ì´ë™)
                </button>
            </div>
        </div>
    </main>

    <!-- ìš°ì¸¡ í•˜ë‹¨ ì¡°ì´ìŠ¤í‹± ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="joystick-status" class="fixed bottom-6 right-6 bg-white/90 backdrop-blur px-5 py-3 rounded-full shadow-lg border-2 border-slate-200 flex items-center gap-3 z-50 transition-all">
        <span id="status-dot" class="w-3 h-3 rounded-full bg-slate-400 shadow-inner"></span>
        <span id="status-text" class="font-bold text-slate-500 text-sm">ì¡°ì´ìŠ¤í‹± ë¯¸ì—°ê²°</span>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="toast-container"></div>

    <!-- ëª¨ë‹¬: ì²˜ìŒìœ¼ë¡œ í™•ì¸ -->
    <div id="modal-confirm-home" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4 z-[110]">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 text-center pop-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 via-blue-500 to-rose-500"></div>
            <div class="mb-6">
                <div class="w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-rounded text-5xl text-rose-500">priority_high</span>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">ì ê¹ë§Œìš”!</h3>
                <p class="text-slate-500 text-lg break-keep">ì§€ê¸ˆ ëŒì•„ê°€ë©´ ì§„í–‰ ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì ¸ìš”.<br>ì²« í™”ë©´ìœ¼ë¡œ ì´ë™í• ê¹Œìš”?</p>
            </div>
            <div class="flex gap-3 justify-center">
                <button onclick="closeHomeModal()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3.5 rounded-xl transition-colors">
                    ê³„ì† í•˜ê¸°
                </button>
                <button onclick="confirmGoToMenu()" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white font-bold py-3.5 rounded-xl shadow-md transition-colors">
                    ì´ë™í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ì „ë¬¸ì  í›ˆë ¨ íš¨ê³¼ -->
    <div id="modal-effect" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col pop-in">
            <div class="bg-slate-800 p-6 sm:p-8 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <span class="material-symbols-rounded text-4xl text-white">neurology</span>
                    <div>
                        <h3 class="text-white text-2xl sm:text-3xl font-bold">ì¸ì§€ ì¬í™œ ë° ë‡Œ ê°€ì†Œì„± í›ˆë ¨ íš¨ê³¼</h3>
                        <p class="text-slate-400 text-sm sm:text-base mt-1">Cognitive Rehabilitation & Neuroplasticity Training Effects</p>
                    </div>
                </div>
                <button onclick="closeEffectModal()" class="text-white/60 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors">
                    <span class="material-symbols-rounded text-3xl">close</span>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 sm:p-10 text-body bg-slate-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- ì„¹ì…˜ 1 -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2 border-indigo-100 flex items-center gap-2">
                            1. ì§‘í–‰ ê¸°ëŠ¥ (Executive Function)
                        </h4>
                        <p class="text-slate-600 leading-relaxed mb-3">
                            ë³¸ ê³¼ì œëŠ” ì „ë‘ì—½(Frontal Lobe)ì„ í™œì„±í™”í•˜ì—¬ ëª©í‘œ ì§€í–¥ì ì¸ í–‰ë™ì„ ê³„íší•˜ê³  ì‹¤í–‰í•˜ëŠ” ëŠ¥ë ¥ì„ í›ˆë ¨í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    <!-- ì„¹ì…˜ 2 -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2 border-indigo-100 flex items-center gap-2">
                            2. ì‹œê°-ìš´ë™ í†µí•© (Visuomotor Integration)
                        </h4>
                        <p class="text-slate-600 leading-relaxed mb-3">
                            í›„ë‘ì—½(Occipital Lobe)ì—ì„œ ì²˜ë¦¬ëœ ì‹œê° ì •ë³´ë¥¼ ë‘ì •ì—½(Parietal Lobe)ì„ ê±°ì³ ìš´ë™ í”¼ì§ˆë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    <!-- ì„¹ì…˜ 3 -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2 border-indigo-100 flex items-center gap-2">
                            3. ì‘ì—… ê¸°ì–µ (Working Memory)
                        </h4>
                        <p class="text-slate-600 leading-relaxed mb-3">
                            ìˆœì°¨ì ìœ¼ë¡œ ì œì‹œë˜ëŠ” ìƒ‰ìƒ ì •ë³´ë¥¼ ë‹¨ê¸°ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ì¸ì¶œí•˜ëŠ” ê³¼ì •ì€ ì‘ì—… ê¸°ì–µ ìš©ëŸ‰ì„ í™•ì¥ì‹œí‚µë‹ˆë‹¤.
                        </p>
                    </div>
                    <!-- ì„¹ì…˜ 4 -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2 border-indigo-100 flex items-center gap-2">
                            4. ì²˜ë¦¬ ì†ë„ (Processing Speed)
                        </h4>
                        <p class="text-slate-600 leading-relaxed mb-3">
                            ìê·¹ ì œì‹œë¶€í„° ë°˜ì‘ê¹Œì§€ì˜ ì ë³µê¸°(Latency)ë¥¼ ë‹¨ì¶•ì‹œí‚¤ëŠ” ë°˜ë³µ í›ˆë ¨ì€ ì¸ì§€ ì²˜ë¦¬ ì†ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 bg-white shrink-0 flex justify-end">
                <button onclick="closeEffectModal()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-xl text-lg transition-colors">
                    í™•ì¸ ë° ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const SOUNDS = { START: 'start', PROBLEM: 'problem', CORRECT: 'correct', WRONG: 'wrong', FINISH: 'finish' };

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === SOUNDS.PROBLEM) {
                osc.type = 'sine'; osc.frequency.setValueAtTime(659, now); osc.frequency.exponentialRampToValueAtTime(1318, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === SOUNDS.CORRECT) {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === SOUNDS.WRONG) {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === SOUNDS.FINISH) {
                playNote(523, now, 0.1); playNote(659, now+0.1, 0.1); playNote(784, now+0.2, 0.4);
            }
        }
        function playNote(freq, time, dur) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = freq; g.gain.setValueAtTime(0.1, time); g.gain.linearRampToValueAtTime(0, time + dur);
            o.start(time); o.stop(time + dur);
        }

        const CONFIG = {
            TOTAL_ROUNDS: 10,
            BUTTONS: { YELLOW: 1, RED: 0, BLUE: 3, GREEN: 2, UP: 8, CONFIRM: 9, DOWN: 17 },
            COLORS: ['red', 'yellow', 'green', 'blue']
        };

        let state = {
            screen: 'MENU', gamepadIndex: null, menuIndex: 0,
            level: 1, round: 1, sequence: [], inputIndex: 0,
            startTime: 0, roundTimes: [], totalErrors: 0,
            isRoundActive: false, lastButtonState: {}, lastNavTime: 0
        };

        const els = {
            screens: { menu: document.getElementById('screen-menu'), game: document.getElementById('screen-game'), result: document.getElementById('screen-result') },
            status: { dot: document.getElementById('status-dot'), text: document.getElementById('status-text'), container: document.getElementById('joystick-status'), iconContainer: document.getElementById('icon-joystick-container') },
            menuList: document.getElementById('level-list'),
            game: {
                level: document.getElementById('display-level'), round: document.getElementById('display-round'),
                msg: document.getElementById('msg-center'), container: document.getElementById('sequence-container'),
                currentSpeed: document.getElementById('current-speed')
            },
            result: {
                level: document.getElementById('result-level-num'), avgTime: document.getElementById('result-avg-time'),
                accuracy: document.getElementById('result-accuracy'), feedback: document.getElementById('result-feedback')
            },
            modal: document.getElementById('modal-effect'),
            modalHome: document.getElementById('modal-confirm-home')
        };

        function init() {
            renderMenu();
            updateStatus(false);
            window.addEventListener("gamepadconnected", (e) => { state.gamepadIndex = e.gamepad.index; updateStatus(true); showToast("ğŸ® ê²Œì„íŒ¨ë“œê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!"); });
            window.addEventListener("gamepaddisconnected", (e) => { if (state.gamepadIndex === e.gamepad.index) { state.gamepadIndex = null; updateStatus(false); showToast("ê²Œì„íŒ¨ë“œ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤."); } });
            requestAnimationFrame(gameLoop);
        }

        function updateStatus(connected) {
            if (connected) {
                els.status.container.className = "fixed bottom-6 right-6 bg-green-50/90 backdrop-blur px-5 py-3 rounded-full shadow-lg border-2 border-green-200 flex items-center gap-3 z-50 transition-all";
                els.status.dot.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                els.status.text.innerText = "ì¡°ì´ìŠ¤í‹± ì—°ê²°ë¨";
                els.status.text.className = "font-bold text-green-700 text-sm";
                els.status.iconContainer.classList.remove('device-joystick-inactive');
                els.status.iconContainer.classList.add('device-joystick-active'); // ë³€ê²½ë¨
            } else {
                els.status.container.className = "fixed bottom-6 right-6 bg-white/90 backdrop-blur px-5 py-3 rounded-full shadow-lg border-2 border-slate-200 flex items-center gap-3 z-50 transition-all";
                els.status.dot.className = "w-3 h-3 rounded-full bg-slate-300";
                els.status.text.innerText = "ì¡°ì´ìŠ¤í‹± ë¯¸ì—°ê²°";
                els.status.text.className = "font-bold text-slate-500 text-sm";
                els.status.iconContainer.classList.remove('device-joystick-active'); // ë³€ê²½ë¨
                els.status.iconContainer.classList.add('device-joystick-inactive');
            }
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-msg';
            toast.innerHTML = msg;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.4s forwards';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function showJoystickToast() {
            if(state.gamepadIndex !== null) {
                showToast('ğŸ® ê²Œì„íŒ¨ë“œë¡œ í”Œë ˆì´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            } else {
                showToast('ğŸ”Œ ê²Œì„íŒ¨ë“œë¥¼ ì—°ê²°í•´ ì£¼ì„¸ìš”.');
            }
        }

        function openEffectModal() { els.modal.classList.remove('hidden'); }
        function closeEffectModal() { els.modal.classList.add('hidden'); }
        
        function goToMenu() { 
            state.screen = 'MENU'; 
            updateScreenVisibility(); 
            closeHomeModal(); 
        }
        
        function goToMenuConfirm() { els.modalHome.classList.remove('hidden'); }
        function closeHomeModal() { els.modalHome.classList.add('hidden'); }
        function confirmGoToMenu() { goToMenu(); }

        function updateScreenVisibility() {
            Object.values(els.screens).forEach(el => el.classList.add('hidden'));
            if (state.screen === 'MENU') { els.screens.menu.classList.remove('hidden'); }
            else if (state.screen === 'PLAYING') { els.screens.game.classList.remove('hidden'); }
            else if (state.screen === 'RESULT') { els.screens.result.classList.remove('hidden'); }
        }

        function handleTouch(btnIdx) {
            if (state.screen === 'PLAYING') {
                const el = document.getElementById(`feedback-${btnIdx}`);
                if(el) {
                    el.classList.add('active');
                    setTimeout(() => el.classList.remove('active'), 150);
                }
                if (state.isRoundActive) checkAnswer(btnIdx);
            }
        }

        function renderMenu() {
            els.menuList.innerHTML = '';
            for (let i = 1; i <= 6; i++) {
                const div = document.createElement('div');
                div.className = `menu-item ${state.menuIndex === (i-1) ? 'selected' : ''}`;
                div.onclick = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); startGame(i); };
                
                let difficultyText = "";
                if(i === 1) difficultyText = "ê¸°ì´ˆ (1ê°œ)";
                else if(i === 3) difficultyText = "ì¤‘ê¸‰ (3ê°œ)";
                else if(i === 5) difficultyText = "ì‹¬í™” (5ê°œ)";
                else if(i === 6) difficultyText = "ë§ˆìŠ¤í„° (6ê°œ)";
                else difficultyText = `(${i}ê°œ)`;

                div.innerHTML = `<span class="font-bold text-xl sm:text-2xl">LEVEL ${i}</span> <span class="font-bold text-slate-400 text-sm sm:text-lg mt-1">${difficultyText}</span>`;
                els.menuList.appendChild(div);
            }
        }

        function gameLoop() { pollGamepad(); requestAnimationFrame(gameLoop); }

        function pollGamepad() {
            if (state.gamepadIndex === null) {
                const gps = navigator.getGamepads();
                for (let i = 0; i < gps.length; i++) {
                    if (gps[i]) {
                        state.gamepadIndex = i;
                        updateStatus(true);
                        showToast("ğŸ® ê²Œì„íŒ¨ë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        break; 
                    }
                }
                return;
            }

            const gamepad = navigator.getGamepads()[state.gamepadIndex];
            if (!gamepad) {
                state.gamepadIndex = null;
                updateStatus(false);
                return;
            }

            Object.values(CONFIG.BUTTONS).forEach(btnIdx => {
                if (btnIdx >= gamepad.buttons.length) return;
                const isDown = gamepad.buttons[btnIdx].pressed;
                const wasDown = state.lastButtonState[btnIdx] || false;

                if (isDown && !wasDown) {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    handleGamepadInput(btnIdx);
                }
                if (state.screen === 'PLAYING' && [0,1,2,3].includes(btnIdx)) {
                    const el = document.getElementById(`feedback-${btnIdx}`);
                    if(el) { isDown ? el.classList.add('active') : el.classList.remove('active'); }
                }
                state.lastButtonState[btnIdx] = isDown;
            });
        }

        function handleGamepadInput(btnIdx) {
            const now = Date.now();
            if (state.screen === 'MENU') {
                if (now - state.lastNavTime < 150) return;
                if (btnIdx === CONFIG.BUTTONS.DOWN) { state.menuIndex = Math.min(5, state.menuIndex + 3); state.lastNavTime = now; renderMenu(); }
                else if (btnIdx === CONFIG.BUTTONS.UP) { state.menuIndex = Math.max(0, state.menuIndex - 3); state.lastNavTime = now; renderMenu(); } 
                else if (btnIdx === 14) { state.menuIndex = Math.max(0, state.menuIndex - 1); state.lastNavTime = now; renderMenu(); }
                else if (btnIdx === 15) { state.menuIndex = Math.min(5, state.menuIndex + 1); state.lastNavTime = now; renderMenu(); }
                else if (btnIdx === CONFIG.BUTTONS.CONFIRM) { els.modal.classList.contains('hidden') ? startGame(state.menuIndex + 1) : closeEffectModal(); }
            } else if (state.screen === 'PLAYING') {
                if (state.isRoundActive && [0,1,2,3].includes(btnIdx)) checkAnswer(btnIdx);
            } else if (state.screen === 'RESULT') {
                if (btnIdx === CONFIG.BUTTONS.CONFIRM) goToMenu();
            }
        }

        function startGame(level) {
            state.level = level;
            state.round = 1;
            state.roundTimes = [];
            state.totalErrors = 0;
            state.screen = 'PLAYING';
            updateScreenVisibility();
            updateHUD();
            startRound();
        }

        function updateHUD() {
            els.game.level.innerText = state.level;
            els.game.round.innerText = state.round;
            const lastTime = state.roundTimes.length > 0 ? state.roundTimes[state.roundTimes.length-1] + "ms" : "-";
            els.game.currentSpeed.innerText = lastTime;
        }

        function startRound() {
            state.isRoundActive = false;
            state.inputIndex = 0;
            state.sequence = [];
            els.game.container.innerHTML = '';
            els.game.msg.innerText = "ì¤€ë¹„";
            els.game.msg.className = "text-responsive-msg font-black game-font text-slate-300";

            for (let i = 0; i < state.level; i++) state.sequence.push(Math.floor(Math.random() * 4));

            state.sequence.forEach((colorIdx, idx) => {
                const dot = document.createElement('div');
                dot.className = `sequence-block`; 
                dot.dataset.targetColor = CONFIG.COLORS[colorIdx];
                els.game.container.appendChild(dot);
            });

            setTimeout(() => {
                els.game.msg.innerText = "ì‹œì‘!";
                els.game.msg.className = "text-responsive-msg font-black game-font text-sky-600 scale-110 transition-transform duration-200";
                playSound(SOUNDS.PROBLEM);
                
                const blocks = document.querySelectorAll('.sequence-block');
                blocks.forEach(b => {
                    b.classList.add(`color-${b.dataset.targetColor}`);
                    b.classList.add('lit');
                });

                state.startTime = Date.now();
                state.isRoundActive = true;
            }, 1000 + (Math.random() * 500));
        }

        function checkAnswer(btnIdx) {
            const targetColorIdx = state.sequence[state.inputIndex];
            if (btnIdx === targetColorIdx) {
                playSound(SOUNDS.CORRECT);
                const blocks = document.querySelectorAll('.sequence-block');
                blocks[state.inputIndex].classList.remove('lit');
                blocks[state.inputIndex].classList.add('done');
                state.inputIndex++;

                if (state.inputIndex >= state.sequence.length) {
                    const reactionTime = Date.now() - state.startTime;
                    state.roundTimes.push(reactionTime);
                    state.isRoundActive = false;
                    els.game.msg.innerText = `${reactionTime}ms`;
                    els.game.msg.className = "text-responsive-msg font-black game-font text-green-500";
                    els.game.currentSpeed.innerText = `${reactionTime}ms`;
                    setTimeout(nextRound, 800);
                }
            } else {
                playSound(SOUNDS.WRONG);
                state.totalErrors++;
                const blocks = document.querySelectorAll('.sequence-block');
                if (blocks[state.inputIndex]) {
                    const wrongBlock = blocks[state.inputIndex];
                    wrongBlock.style.transform = "translateX(10px)";
                    setTimeout(() => wrongBlock.style.transform = "translateX(0)", 100);
                }
                document.body.style.backgroundColor = "#fee2e2";
                setTimeout(() => document.body.style.backgroundColor = "#f0f9ff", 200);
            }
        }

        function nextRound() {
            if (state.round >= CONFIG.TOTAL_ROUNDS) finishGame();
            else { state.round++; updateHUD(); startRound(); }
        }

        function finishGame() {
            playSound(SOUNDS.FINISH);
            const sum = state.roundTimes.reduce((a, b) => a + b, 0);
            const avg = Math.floor(sum / state.roundTimes.length);
            const totalClicks = state.roundTimes.length * state.level + state.totalErrors; 
            const accuracy = Math.max(0, Math.floor(((totalClicks - state.totalErrors) / totalClicks) * 100));

            els.result.level.innerText = state.level;
            els.result.avgTime.innerText = `${avg}ms`;
            els.result.accuracy.innerText = `${accuracy}%`;

            let feedback = "";
            const baseSpeed = 500 * state.level;

            if (accuracy >= 95) {
                if (avg < baseSpeed * 0.8) feedback = "ë§¤ìš° ë›°ì–´ë‚œ ì²˜ë¦¬ ì†ë„ì™€ ì •í™•ì„±ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.";
                else if (avg < baseSpeed) feedback = "ì•ˆì •ì ì¸ ì²˜ë¦¬ ì†ë„ì™€ ë†’ì€ ì •í™•ë„ë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.";
                else feedback = "ì •í™•í•œ ìˆ˜í–‰ì— ê°•ì ì´ ìˆìœ¼ë‚˜, ë°˜ì‘ ì†ë„ë¥¼ ë†’ì´ëŠ” í›ˆë ¨ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            } else if (accuracy >= 80) {
                if (avg < baseSpeed) feedback = "ë°˜ì‘ ì†ë„ëŠ” ìš°ìˆ˜í•˜ë‚˜ ê°„í—ì ì¸ ì‹¤ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.";
                else feedback = "ì „ë°˜ì ì¸ ìˆ˜í–‰ë ¥ì€ ì–‘í˜¸í•©ë‹ˆë‹¤. ì •í™•ë„ë¥¼ ë†’ì´ì„¸ìš”.";
            } else {
                feedback = "ê¸°ì´ˆì ì¸ ì£¼ì˜ë ¥ í›ˆë ¨ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
            }

            els.result.feedback.innerText = feedback;
            state.screen = 'RESULT';
            updateScreenVisibility();
        }

        init();
    </script>
</body>
</html>